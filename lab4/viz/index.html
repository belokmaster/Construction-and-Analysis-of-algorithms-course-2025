<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KMP Algorithm Visualization</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .controls { margin-bottom: 20px; }
        canvas { border: 1px solid #ccc; }
        #status { margin-top: 10px; }
        #speed-label { margin-left: 10px; }
        .step-controls { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>KMP Algorithm Visualization</h1>
    <div class="controls">
        <label for="text">Text:</label>
        <input type="text" id="text" value="aababcabcdabcdeabcdef"><br><br>
        <label for="pattern">Pattern:</label>
        <input type="text" id="pattern" value="abcdef"><br><br>
        <label for="speed">Animation Speed:</label>
        <input type="range" id="speed" min="100" max="1000" value="500" step="100">
        <span id="speed-label">500 ms</span><br><br>
        <button onclick="startAnimation()">Start Animation</button>
        <button onclick="pauseAnimation()">Pause</button>
        <button onclick="reset()">Reset</button>
        <div class="step-controls">
            <button onclick="prevStep()">Previous Step</button>
            <button onclick="nextStep()">Next Step</button>
            <span id="step-counter">Step: 0/0</span>
        </div>
    </div>
    <canvas id="canvas" width="800" height="200"></canvas>
    <div id="status"></div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const BOX_WIDTH = 30;
        const BOX_HEIGHT = 30;
        const MARGIN_X = 40;
        const MARGIN_Y = 40;
        const ROW_SPACING = 20;
        let steps = [];
        let currentStep = 0;
        let text = "";
        let pattern = "";
        let animationId = null;
        let isAnimating = false;

        // Обновление метки скорости
        const speedInput = document.getElementById("speed");
        const speedLabel = document.getElementById("speed-label");
        speedInput.addEventListener("input", () => {
            speedLabel.textContent = `${speedInput.value} ms`;
        });

        function updateStepCounter() {
            document.getElementById("step-counter").textContent = `Step: ${currentStep + 1}/${steps.length}`;
        }

        function drawCharBox(x, y, value, active) {
            ctx.fillStyle = active ? "#f00" : "#000";
            ctx.strokeStyle = "#000";
            ctx.strokeRect(x, y, BOX_WIDTH, BOX_HEIGHT);
            ctx.fillText(value, x + BOX_WIDTH / 2 - 5, y + BOX_HEIGHT / 2 + 5);
        }

        function drawTextAndPattern(stepIndex) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Arial";
            ctx.textAlign = "left";

            if (steps.length === 0 || stepIndex < 0 || stepIndex >= steps.length) return;

            // Отрисовка текста
            for (let i = 0; i < text.length; i++) {
                const x = MARGIN_X + i * BOX_WIDTH;
                const y = MARGIN_Y;
                const active = i === steps[stepIndex].textIndex;
                drawCharBox(x, y, text[i], active);
            }

            // Отрисовка подстроки с учетом сдвига
            const shift = steps[stepIndex].textIndex - steps[stepIndex].patternIndex;
            for (let i = 0; i < pattern.length; i++) {
                const x = MARGIN_X + (i + shift) * BOX_WIDTH;
                const y = MARGIN_Y + BOX_HEIGHT + ROW_SPACING;
                const active = i === steps[stepIndex].patternIndex;
                drawCharBox(x, y, pattern[i], active);
            }

            // Обновление статуса
            document.getElementById("status").textContent = 
                `Step ${stepIndex + 1}: ${steps[stepIndex].status} (Comparisons: ${steps[stepIndex].comparisons})`;
            
            updateStepCounter();
        }

        function animate() {
            if (currentStep >= steps.length) {
                pauseAnimation();
                document.getElementById("status").textContent += "\nAnimation finished.";
                return;
            }

            drawTextAndPattern(currentStep);
            currentStep++;
            
            if (isAnimating) {
                const delay = parseInt(speedInput.value);
                setTimeout(() => {
                    animationId = requestAnimationFrame(animate);
                }, delay);
            }
        }

        function startAnimation() {
            const textInput = document.getElementById("text").value;
            const patternInput = document.getElementById("pattern").value;

            fetch('/kmp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: textInput, pattern: patternInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("status").textContent = `Error: ${data.error}`;
                    return;
                }

                text = textInput;
                pattern = patternInput;
                steps = data.steps;
                currentStep = 0;
                isAnimating = true;
                if (animationId) cancelAnimationFrame(animationId);
                animate();
            })
            .catch(err => {
                console.error(err);
                document.getElementById("status").textContent = "An error occurred.";
            });
        }

        function pauseAnimation() {
            isAnimating = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                drawTextAndPattern(currentStep);
            }
        }

        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                drawTextAndPattern(currentStep);
            }
        }

        function reset() {
            document.getElementById("text").value = "aababcabcdabcdeabcdef";
            document.getElementById("pattern").value = "abcdef";
            document.getElementById("speed").value = "500";
            speedLabel.textContent = "500 ms";
            document.getElementById("status").textContent = "";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pauseAnimation();
            steps = [];
            currentStep = 0;
            updateStepCounter();
        }
    </script>
</body>
</html>